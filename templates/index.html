<!DOCTYPE html>
<html lang="en">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tai Chi Similarity Measure</title>
</head>
<body>
    <h2>Test Similarity of Tai Chi</h2>
    <video id="video" autoplay></video>

    <div id="video-container" style="text-align: center;">
        <div style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 10px;">
            <button id="recordBtn" onclick="toggleRecording()" class="custom-button">Start Recording</button>
            <span>or</span>
            <label for="file-input" class="custom-button">Choose File</label>
            <input type="file" id="file-input" accept="video/*" style="display: none;">
        </div>
        <p id="file-name"></p>
        <button id="uploadBtn" onclick="uploadRecordedVideo()" disabled class="custom-button">Test Similarity</button>
    </div>
    
    <hr>

    <!-- üìä ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå -->
    <h3>Similarity Score</h3>
    <div id="score-container" style="border: 1px solid #000; padding: 15px; border-radius: 5px; width: 300px; margin: 10px auto; background-color: white;">
        <p id="accuracy"> 0%</p>
        <!--<p>DTW Distance: <span id="dtw-distance">-</span></p>-->
        <!--<p>Matched Frames: <span id="matched-frames">-</span></p>-->
    </div>
    <div id="result" style="text-align: center; margin-top: 10px;"></div>

    <!-- Pop-up ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô -->
    <div id="popup-container" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); z-index: 1000; text-align: center;">
        <p id="popup-message">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</p>
    </div>
    <div id="overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 999;"></div>

    <script>
        let isRecording = false;
        let mediaRecorder;
        let recordedChunks = [];
        let recordedBlob = null;
    
        async function toggleRecording() {
            const recordBtn = document.getElementById("recordBtn");
            const videoElement = document.getElementById("video");
    
            if (!isRecording) {
                // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠
                let stream = await navigator.mediaDevices.getUserMedia({ video: true });
                videoElement.srcObject = stream;
    
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm; codecs=vp9' });
                recordedChunks = []; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
    
                mediaRecorder.ondataavailable = event => recordedChunks.push(event.data);
                mediaRecorder.onstop = () => {
                    // ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
                    stream.getTracks().forEach(track => track.stop());
    
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Blob ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                    recordedBlob = new Blob(recordedChunks, { type: "video/webm" });
                    let videoURL = URL.createObjectURL(recordedBlob);
                    videoElement.srcObject = null;
                    videoElement.src = videoURL;
                    videoElement.controls = true;
                    videoElement.loop = true;
                    videoElement.play();
    
                    // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
                    document.getElementById("uploadBtn").disabled = false;
                };
    
                mediaRecorder.start();
                recordBtn.textContent = "Stop Recording";
                recordBtn.style.backgroundColor = "red";
                isRecording = true;
            } else {
                // ‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                mediaRecorder.stop();
                recordBtn.textContent = "Start Recording";
                recordBtn.style.backgroundColor = "";
                isRecording = false;
            }
        }
    
        // üìÇ ‡πÄ‡∏•‡πà‡∏ô‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå
        document.getElementById("file-input").addEventListener("change", function(event) {
            let file = event.target.files[0];
            if (file) {
                let videoElement = document.getElementById("video");
                let videoURL = URL.createObjectURL(file);
                videoElement.srcObject = null;
                videoElement.src = videoURL;
                videoElement.controls = true;
                videoElement.loop = true;
                videoElement.play();
    
                document.getElementById("file-name").textContent = ` Selected File: ${file.name}`;
    
                // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
                document.getElementById("uploadBtn").disabled = false;
                recordedBlob = file; // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ
            }
        });
    
        // üì§ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
        async function uploadRecordedVideo() {
            if (!recordedBlob) {
                alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏Å‡πà‡∏≠‡∏ô");
                return;
            }
    
            let formData = new FormData();
            formData.append("file", recordedBlob, recordedBlob.name || "recorded_video.webm");
    
            await sendVideoToServer(formData);
        }
    
        function showPopup(message) {
            const popupContainer = document.getElementById("popup-container");
            const overlay = document.getElementById("overlay");
            const popupMessage = document.getElementById("popup-message");

            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Pop-up
            popupMessage.textContent = message;

            // ‡πÅ‡∏™‡∏î‡∏á Pop-up ‡πÅ‡∏•‡∏∞ Overlay
            popupContainer.style.display = "block";
            overlay.style.display = "block";
        }

        function hidePopup() {
            const popupContainer = document.getElementById("popup-container");
            const overlay = document.getElementById("overlay");

            // ‡∏ã‡πà‡∏≠‡∏ô Pop-up ‡πÅ‡∏•‡∏∞ Overlay
            popupContainer.style.display = "none";
            overlay.style.display = "none";
        }

        // üì° ‡∏™‡πà‡∏á‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÑ‡∏õ‡∏¢‡∏±‡∏á Flask API
        async function sendVideoToServer(formData) {
            showPopup("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...");

            try {
                let response = await fetch("/predict", {
                    method: "POST",
                    body: formData
                });

                let result = await response.json();

                if (response.ok) {
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÉ‡∏ô UI
                    document.getElementById("accuracy").innerText = `${result.overall_matching_accuracy.toFixed(2)}%`;
                    //document.getElementById("dtw-distance").innerText = result.dtw_distance !== undefined ? result.dtw_distance.toFixed(2) : "-";
                    //document.getElementById("matched-frames").innerText = result.matched_frames !== undefined ? `${result.matched_frames} / ${result.total_frames_video1}` : "-";

                    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÉ‡∏ô Pop-up
                    showPopup("‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!");
                    setTimeout(hidePopup, 2000); // ‡∏õ‡∏¥‡∏î Pop-up ‡∏´‡∏•‡∏±‡∏á 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                } else {
                    showPopup(`‚ùå Error: ${result.error}`);
                    setTimeout(hidePopup, 2000);
                }
            } catch (error) {
                showPopup(`‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`);
                setTimeout(hidePopup, 2000);
            }
        }
    </script>
</body>
</html>