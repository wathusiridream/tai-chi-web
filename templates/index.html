<!DOCTYPE html>
<html lang="en">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tai Chi Similarity Measure</title>
</head>
<body>
    <h2>Test Similarity of Tai Chi</h2>

    <video id="video" autoplay></video>

    <div id="video-container" style="text-align: center;">
        <div style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 10px;">
            <button id="recordBtn" onclick="toggleRecording()" class="custom-button">Start Recording</button>
            <span>or</span>
            <label for="file-input" class="custom-button">Choose File</label>
            <input type="file" id="file-input" accept="video/*" style="display: none;" onchange="handleFileInput(event)">
        </div>
        <p id="file-name"></p>
        <button id="uploadBtn" onclick="uploadRecordedVideo()" class="custom-button disabled" disabled>Test Similarity</button>
    </div>
    
    <hr>
    <h3>Similarity Score</h3>
    <div id="score-container">
        <p id="accuracy" style="text-align: center;"> 0%</p>
    </div>
    <div id="result" style="text-align: center; margin-top: 10px;"></div>

    <div id="popup-container">
        <p id="popup-message">กำลังประมวลผล...</p>
        <div class="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
        <p id="progress-text">0%</p>
    </div>
    <div id="overlay"></div>

    <script>
        let isRecording = false;
        let mediaRecorder;
        let recordedChunks = [];
        let recordedBlob = null;
        let stream = null;
    
        function resetData() {
            // รีเซ็ตชื่อไฟล์
            document.getElementById("file-name").textContent = "";
    
            // รีเซ็ตวิดีโอ
            const videoElement = document.getElementById("video");
            videoElement.srcObject = null;
            videoElement.src = "";
            videoElement.controls = false;
    
            // รีเซ็ตความแม่นยำ (accuracy)
            document.getElementById("accuracy").textContent = "0%";
    
            // ปิดปุ่ม Test Similarity
            const uploadBtn = document.getElementById("uploadBtn");
            uploadBtn.disabled = true;
            uploadBtn.classList.add("disabled");
            uploadBtn.classList.remove("enabled");
    
            // รีเซ็ตข้อมูล Blob
            recordedBlob = null;
    
            console.log("All data has been reset.");
        }
    
        async function toggleRecording() {
            const recordBtn = document.getElementById("recordBtn");
            const videoElement = document.getElementById("video");
            const uploadBtn = document.getElementById("uploadBtn");
    
            if (!isRecording) {
                try {
                    console.log("Requesting camera access...");
                    stream = await navigator.mediaDevices.getUserMedia({ video: true });
    
                    if (!stream) {
                        alert("ไม่สามารถเปิดกล้องได้! กรุณาตรวจสอบสิทธิ์ของเบราว์เซอร์.");
                        return;
                    }
    
                    resetData(); // เรียก resetData เมื่อเริ่มบันทึกใหม่
                    videoElement.srcObject = stream;
    
                    mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
                    recordedChunks = [];
    
                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) recordedChunks.push(event.data);
                    };
    
                    mediaRecorder.onstop = () => {
                        console.log("Recording stopped.");
                        stream.getTracks().forEach((track) => track.stop());
    
                        if (recordedChunks.length === 0) {
                            alert("เกิดข้อผิดพลาดในการบันทึกวิดีโอ");
                            return;
                        }
    
                        recordedBlob = new Blob(recordedChunks, { type: "video/webm" });
                        const videoURL = URL.createObjectURL(recordedBlob);
    
                        videoElement.srcObject = null;
                        videoElement.src = videoURL;
                        videoElement.controls = true;
                        videoElement.loop = true;
                        videoElement.play();
    
                        console.log("Video recorded successfully.");
                        uploadBtn.disabled = false;
                        uploadBtn.classList.remove("disabled");
                        uploadBtn.classList.add("enabled");
                    };
    
                    console.log("Starting recording...");
                    mediaRecorder.start();
                    recordBtn.textContent = "Stop Recording";
                    recordBtn.style.backgroundColor = "red";
                    isRecording = true;
    
                } catch (error) {
                    console.error("Error accessing webcam: ", error);
                    alert("ไม่สามารถเข้าถึงกล้องได้! กรุณาตรวจสอบการตั้งค่าของเบราว์เซอร์.");
                }
            } else {
                console.log("Stopping recording...");
                mediaRecorder.stop();
                recordBtn.textContent = "Start Recording";
                recordBtn.style.backgroundColor = "";
                isRecording = false;
            }
        }
    
        function handleFileInput(event) {
            let file = event.target.files[0];
            const videoElement = document.getElementById("video");
            const fileNameElement = document.getElementById("file-name");
            const uploadBtn = document.getElementById("uploadBtn");
    
            if (file) {
                resetData(); // รีเซ็ตข้อมูลทุกครั้งเมื่อเลือกไฟล์ใหม่
    
                const videoURL = URL.createObjectURL(file);
                videoElement.src = videoURL;
                videoElement.controls = true;
                videoElement.play();
    
                fileNameElement.textContent = `Selected File: ${file.name}`;
                recordedBlob = file;
    
                uploadBtn.disabled = false;
                uploadBtn.classList.remove("disabled");
                uploadBtn.classList.add("enabled");
            }
        }
    
        async function uploadRecordedVideo() {
            if (!recordedBlob) {
                alert("ไม่มีวิดีโอ กรุณาบันทึกหรือเลือกวิดีโอก่อน");
                return;
            }
    
            let formData = new FormData();
            formData.append("file", recordedBlob, recordedBlob.name || "recorded_video.webm");
    
            await sendVideoToServer(formData);
        }
    
        function showPopup(message) {
            document.getElementById("popup-message").textContent = message;
            document.getElementById("popup-container").style.display = "block";
            document.getElementById("overlay").style.display = "block";
    
            updateProgressBar(0);
        }
    
        function hidePopup() {
            document.getElementById("popup-container").style.display = "none";
            document.getElementById("overlay").style.display = "none";
    
            updateProgressBar(0);
        }
    
        function updateProgressBar(progress) {
            const progressBar = document.getElementById("progress-bar");
            const progressText = document.getElementById("progress-text");
    
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `${progress}%`;
        }
    
        async function sendVideoToServer(formData) {
            showPopup("กำลังประมวลผล...");
    
            let progress = 0;
            let progressInterval = setInterval(() => {
                if (progress < 90) {
                    progress += Math.floor(Math.random() * 10) + 5;
                    if (progress > 90) progress = 90;
                    updateProgressBar(progress);
                }
            }, 500);
    
            try {
                let response = await fetch("/predict", {
                    method: "POST",
                    body: formData
                });
    
                let result = await response.json();
    
                clearInterval(progressInterval);
                updateProgressBar(100);
    
                if (response.ok) {
                    document.getElementById("accuracy").innerText = `${result.overall_matching_accuracy.toFixed(2)}%`;
    
                    setTimeout(() => {
                        hidePopup();
                    }, 1000);
                } else {
                    showPopup(`❌ Error: ${result.error}`);
                    setTimeout(hidePopup, 2000);
                }
            } catch (error) {
                clearInterval(progressInterval);
                showPopup(`❌ เกิดข้อผิดพลาด: ${error.message}`);
                setTimeout(hidePopup, 2000);
            }
        }
    </script>
    
</body>
</html>
